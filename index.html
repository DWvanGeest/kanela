<html><head><title>kamon-agent</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="kamon-io" /><meta name="description" content="Open Source Java Agent for the JVM" /><meta name="og:image" content="/kamon-agent/img/poster.png" /><meta name="og:title" content="kamon-agent" /><meta name="og:site_name" content="kamon-agent" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Open Source Java Agent for the JVM" /><link rel="icon" type="image/png" href="/kamon-agent/img/favicon.png" /><meta name="twitter:title" content="kamon-agent" /><meta name="twitter:image" content="img/poster.png" /><meta name="twitter:description" content="Open Source Java Agent for the JVM" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/kamon-agent/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/kamon-agent/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/kamon-agent/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/kamon-agent/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/kamon-agent/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/kamon-agent/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/kamon-agent/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/kamon-agent/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/kamon-agent/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/kamon-agent/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/kamon-agent/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/kamon-agent/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/kamon-agent/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/kamon-agent/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/kamon-agent/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/kamon-agent/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/kamon-agent/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/kamon-agent/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/kamon-agent/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/kamon-agent/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/kamon-agent/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/kamon-agent/css/style.css" /><link rel="stylesheet" href="/kamon-agent/css/palette.css" /><link rel="stylesheet" href="/kamon-agent/css/codemirror.css" /></head><body><header id="site-header"><div class="navbar-wrapper"><div class="container"><div class="row"><div class="col-xs-6"><a href="/kamon-agent/" class="brand"><div class="icon-wrapper"><span>kamon-agent</span></div></a></div><div class="col-xs-6"><nav class="text-right"><ul class=""><li><a href="https://github.com/kamon-io/kamon-agent"><i class="fa fa-github"></i><span class="hidden-xs">GitHub</span></a></li></ul></nav></div></div></div></div><div class="jumbotron"><div class="container"><h1 class="text-center">Open Source Java Agent for the JVM</h1><h2></h2><p class="text-center"><a href="https://github.com/kamon-io/kamon-agent" class="btn btn-outline-inverse">View on GitHub</a></p></div></div><div><ul class="horizontalNav">       <li><a class="" href="/kamon-agent/changelog.html">Changelog</a></li>  <li><a class="" href="/kamon-agent/license.html">License</a></li> </ul></div></header><main id="site-main"><section class="use"><div class="container"><div id="content"><h1 id="kamon-agent">Kamon Agent</h1>
<p><a href="https://travis-ci.org/kamon-io/kamon-agent"><img src="https://travis-ci.org/kamon-io/kamon-agent.svg?branch=master" alt="Build Status" /></a></p>

<p>The <strong>kamon-agent</strong> is developed in order to provide a simple way to instrument an application running on the JVM and
introduce kamon features such as, creation of traces, metric measures, trace propagation, and so on.</p>

<p>It’s a simple Java Agent written in Java 8 and powered by <a href="http://bytebuddy.net/#/">ByteBuddy</a> with some additionally <a href="http://asm.ow2.org/">ASM</a> features. It has a Pure-Java API and a
Scala-Friendly API to define the custom instrumentation in a declarative manner.</p>

<p>Kamon has several module that need to instrument the app to introduce itself in the internal components. Introducing this Agent,
you have other way to instrument your <code class="highlighter-rouge">app / library / framework</code> through a simple and declarative API and get additional features such as
retransformation of the loaded classes (so it’s possible to attach agent on the runtime), revoke the instrumentation
when the app is in a critical state, and so on.</p>

<h3 id="how-to-use-the-agent-api">How to use the Agent API?</h3>

<p>The API has a version for <em>Java</em> and other one for <em>Scala</em>. To define the transformations you have to extends the
<code class="highlighter-rouge">KamonInstrumentation</code> type (picking the Java or the Scala version) and define a new module in the configuration, as you can see
in the following example.</p>

<h2 id="example">Example</h2>

<p>Suppose you have a simple worker that perform a simple operation:</p>

<div class="code-example"><ul class="nav nav-tabs language-tab justify-content-end" role="tablist"><li class="nav-item active"><a class="nav-link" data-toggle="tab" href="#java_0_645644" role="tab">Java</a></li><li class="nav-item"><a class="nav-link" data-toggle="tab" href="#scala_1_645644" role="tab">Scala</a></li></ul><div class="tab-content"><div class="tab-pane active" id="java_0_645644" role="tabpanel"><pre class="line-numbers language-java"><code class="language-java">import java.util.Random;

public class Worker {
  private final Random random = new Random();

  public void performTask() {
      Thread.sleep((long)(random.nextFloat() * 500));
  }
}
</code></pre></div><div class="tab-pane" id="scala_1_645644" role="tabpanel"><pre class="line-numbers language-scala"><code class="language-scala">import scala.util.Random

case class Worker() {
  def performTask(): Unit = Thread.sleep((Random.nextFloat() * 500) toLong)
}
</code></pre></div></div></div>

<p>You might want to mixin it with a type that provide a way to accumulate metrics, such as the following:</p>

<div class="code-example"><ul class="nav nav-tabs language-tab justify-content-end" role="tablist"><li class="nav-item active"><a class="nav-link" data-toggle="tab" href="#java_0_901189" role="tab">Java</a></li><li class="nav-item"><a class="nav-link" data-toggle="tab" href="#scala_1_901189" role="tab">Scala</a></li></ul><div class="tab-content"><div class="tab-pane active" id="java_0_901189" role="tabpanel"><pre class="line-numbers language-java"><code class="language-java">public interface MonitorAware {
    Map&lt;String, List&lt;Long&gt;&gt; execTimings();
    List&lt;Long&gt; addExecTimings(String methodName, long time);
}
</code></pre></div><div class="tab-pane" id="scala_1_901189" role="tabpanel"><pre class="line-numbers language-scala"><code class="language-scala">trait MonitorAware {
  def execTimings: Map[String, Vector[Long]]
  def addExecTimings(methodName: String, time: Long): Vector[Long]
}
</code></pre></div></div></div>

<p>And introduce some transformations in order to modify the bytecode and hook into the internal app.</p>

<div class="code-example"><ul class="nav nav-tabs language-tab justify-content-end" role="tablist"><li class="nav-item active"><a class="nav-link" data-toggle="tab" href="#java_0_447313" role="tab">Java</a></li><li class="nav-item"><a class="nav-link" data-toggle="tab" href="#scala_1_447313" role="tab">Scala</a></li></ul><div class="tab-content"><div class="tab-pane active" id="java_0_447313" role="tabpanel"><pre class="line-numbers language-java"><code class="language-java">import kamon.agent.api.instrumentation.KamonInstrumentation;
// And other imports !
public class MonitorInstrumentation extends KamonInstrumentation {
    public MonitorInstrumentation() {
        forTargetType(() -&gt; &quot;app.kamon.java.Worker&quot;, builder -&gt;
            builder.withMixin(() -&gt; MonitorMixin.class)
                   .withAdvisorFor(named(&quot;performTask&quot;), () -&gt; WorkerAdvisor.class)
                   .build()
        );
    }
}
</code></pre></div><div class="tab-pane" id="scala_1_447313" role="tabpanel"><pre class="line-numbers language-scala"><code class="language-scala">import kamon.agent.scala.KamonInstrumentation
// And other imports !
class MonitorInstrumentation extends KamonInstrumentation {
  forTargetType(&quot;app.kamon.Worker&quot;) { builder ⇒
    builder
      .withMixin(classOf[MonitorMixin])
      .withAdvisorFor(named(&quot;performTask&quot;), classOf[WorkerAdvisor])
      .build()
  }
}
</code></pre></div></div></div>

<div class="code-example"><ul class="nav nav-tabs language-tab justify-content-end" role="tablist"><li class="nav-item active"><a class="nav-link" data-toggle="tab" href="#java_0_808827" role="tab">Java</a></li><li class="nav-item"><a class="nav-link" data-toggle="tab" href="#scala_1_808827" role="tab">Scala</a></li></ul><div class="tab-content"><div class="tab-pane active" id="java_0_808827" role="tabpanel"><pre class="line-numbers language-java"><code class="language-java">public class MonitorMixin implements MonitorAware {

    private Map&lt;String, List&lt;Long&gt;&gt; _execTimings;

    @Override
    public List&lt;Long&gt; execTimings(String methodName) {
        return _execTimings.getOrDefault(methodName, List.empty());
    }

    @Override
    public Map&lt;String, List&lt;Long&gt;&gt; execTimings() {
        return _execTimings;
    }

    @Override
    public List&lt;Long&gt; addExecTimings(String methodName, long time) {
        return this._execTimings.compute(methodName, (key, oldValues) -&gt; Option.of(oldValues).map(vs -&gt; vs.append(time)).getOrElse(List.of(time)));
    }

    @Initializer
    public void init() {
        this._execTimings = new ConcurrentHashMap&lt;&gt;();
    }
}
</code></pre></div><div class="tab-pane" id="scala_1_808827" role="tabpanel"><pre class="line-numbers language-scala"><code class="language-scala">class MonitorMixin extends MonitorAware {

  private var _execTimings: TrieMap[String, CopyOnWriteArrayList[Long]] = _

  def execTimings: TrieMap[String, CopyOnWriteArrayList[Long]] = this._execTimings

  def execTimings(methodName: String): java.util.List[Long] = this._execTimings.getOrElse(methodName, new CopyOnWriteArrayList())

  def addExecTimings(methodName: String, time: Long): java.util.List[Long] = {
    val update = this._execTimings.getOrElseUpdate(methodName, new CopyOnWriteArrayList())
    update.add(time)
    update
  }

  @Initializer
  def init(): Unit = this._execTimings = TrieMap[String, CopyOnWriteArrayList[Long]]()
}
</code></pre></div></div></div>

<div class="code-example"><ul class="nav nav-tabs language-tab justify-content-end" role="tablist"><li class="nav-item active"><a class="nav-link" data-toggle="tab" href="#java_0_328113" role="tab">Java</a></li><li class="nav-item"><a class="nav-link" data-toggle="tab" href="#scala_1_328113" role="tab">Scala</a></li></ul><div class="tab-content"><div class="tab-pane active" id="java_0_328113" role="tabpanel"><pre class="line-numbers language-java"><code class="language-java">public class WorkerAdvisor {

    @OnMethodEnter
    public static long onMethodEnter() {
        return System.nanoTime(); // Return current time, entering as parameter in the onMethodExist
    }

    @OnMethodExit
    public static void onMethodExit(@This MonitorAware instance, @Enter long start, @Origin String origin) {
        long timing = System.nanoTime() - start;
        instance.addExecTimings(origin, timing);
        System.out.println(String.format(&quot;Method %s was executed in %10.2f ns.&quot;, origin, (float) timing));
    }
}
</code></pre></div><div class="tab-pane" id="scala_1_328113" role="tabpanel"><pre class="line-numbers language-scala"><code class="language-scala">object WorkerAdvisor {

  @OnMethodEnter
  def onMethodEnter(): Long = {
    System.nanoTime() // Return current time, entering as parameter in the onMethodExist
  }

  @OnMethodExit
  def onMethodExit(@This instance: MonitorAware, @Enter start: Long, @Origin origin: String): Unit = {
    val timing = System.nanoTime() - start
    instance.addExecTimings(origin, timing)
    println(s&quot;Method $origin was executed in $timing ns.&quot;)
  }
}
</code></pre></div></div></div>

<p>Finally, we need to define a new module in the kamon agent configuration:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">kamon</span><span class="p">.</span><span class="nx">agent</span> <span class="p">{</span>
  <span class="nx">modules</span> <span class="p">{</span>
    <span class="nx">example</span><span class="o">-</span><span class="nx">module</span> <span class="p">{</span>
      <span class="nx">name</span> <span class="o">=</span> <span class="s2">"Example Module"</span>
      <span class="nx">stoppable</span> <span class="o">=</span> <span class="kc">false</span>
      <span class="nx">instrumentations</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"app.kamon.instrumentation.MonitorInstrumentation"</span><span class="p">]</span>
      <span class="nx">within</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">"app.kamon..*"</span> <span class="p">]</span> <span class="c1">// List of patterns to match the types to instrument.</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>And you are ready to go!</p>

<p>Next, just run your app with the <code class="highlighter-rouge">kamon-agent</code> as parameter:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>java -javaagent:kamon-agent.jar -jar /path/to/footpath-routing-api.jar
</code></pre>
</div>

<p>There it is! Your app instrumented with kamon-agent ready to introduce kamon under the hook.</p>

<p>Some other configuration that you can define is indicated in the agent <a href="https://github.com/kamon-io/kamon-agent/blob/master/agent/src/main/resources/reference.conf"><code class="highlighter-rouge">reference.conf</code></a></p>

<h2 id="lombok">Lombok</h2>
<p>This project uses <a href="https://projectlombok.org/">Lombok</a> to reduce boilerplate. You can setup
the <a href="https://plugins.jetbrains.com/plugin/6317">IntelliJ plugin</a> to add IDE support.</p>

</div></div></section><section class="technologies"><div class="container"><div class="row"></div></div></section></main><footer id="site-footer"><div class="container"><div class="row"><div class="col-xs-6"><p>kamon-agent is designed and developed by <a href="" target="_blank">kamon-io</a></p></div><div class="col-xs-6"><p class="text-right"><a href="https://github.com/kamon-io/kamon-agent"><span class="fa fa-github"></span>View on GitHub</a></p></div></div><div class="row"><div class="col-xs-6"><p>Website built with <a href="https://47deg.github.io/sbt-microsites/" target="_blank">Sbt-microsites</a> - © 2016 <a href="https://www.47deg.com/" target="_blank">47 Degrees</a></p></div></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/kamon-agent/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script>((window.gitter = {}).chat = {}).options = {
room: 'kamon-io/Kamon'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script></body></html>